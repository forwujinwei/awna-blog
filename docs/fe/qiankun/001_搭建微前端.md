# 搭建微前端

## 主应用配置

### 创建主应用

```
vue create quankun-main
```

### 添加qiankun

```
yarn add quankun
```

### 添加element-ui

```
yarn add quankun
```

### 配置main.js

```
import Vue from 'vue'
import App from './App.vue'
import createRouter from './router'
import ElementUI from 'element-ui'
import 'element-ui/lib/theme-chalk/index.css'
import { registerMicroApps, setDefaultMountApp, start } from 'qiankun'

Vue.config.productionTip = false
Vue.use(ElementUI)

let app = null
let router = createRouter()

/**
 * 渲染函数
 * appContent 子应用html内容
 * loading 子应用加载效果，可选
 */
function render({ appContent, loading } = {}) {
  if (!app) {
    app = new Vue({
      el: '#main-app', // 这里的id需要与index.html中的id一致
      router,
      data() {
        return {
          content: appContent,
          loading,
        }
      },
      render(h) {
        return h(App, {
          props: {
            content: this.content,
            loading: this.loading,
          },
        })
      },
    })
  } else {
    app.content = appContent
    app.loading = loading
  }
}

/**
 * 路由监听
 * @param {*} routerPrefix 前缀
 */
function genActiveRule(routerPrefix) {
  return (location) => location.pathname.startsWith(routerPrefix)
}

function initApp() {
  render({ appContent: '', loading: true })
}

initApp()

// 传入子应用的数据
let msg = {
  data: {
    auth: false,
  },
  fns: [
    {
      name: '_LOGIN',
      _LOGIN(data) {
        console.log(`父应用返回信息${data}`)
      },
    },
  ],
}

// 注册子应用
registerMicroApps(
  [
    {
      name: 'sub-demo1',
      entry: '//localhost:8091',
      render,
      activeRule: genActiveRule('/app1'),
      props: msg,
    },
    // {
    //   name: 'sub-app-2',
    //   entry: '//localhost:8092',
    //   render,
    //   activeRule: genActiveRule('/app2'),
    // },
  ],
  {
    beforeLoad: [
      (app) => {
        console.log('before load', app)
      },
    ], // 挂载前回调
    beforeMount: [
      (app) => {
        console.log('before mount', app)
      },
    ], // 挂载后回调
    afterUnmount: [
      (app) => {
        console.log('after unload', app)
      },
    ], // 卸载后回调
  }
)

// 设置默认子应用,与 genActiveRule中的参数保持一致
setDefaultMountApp('/app1')

// 启动
start()

```

### 配置vue.config.js

如果根目录下没有`vue.config.js`,新建`vue.config.js`

```
module.exports = {
  devServer: {
    open: true,
    port: 8090,
    headers: {
      'Access-Control-Allow-Origin': '*',
    },
  },
}

```

### 修改index.html

```
<!DOCTYPE html>
<html lang="">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <link rel="icon" href="<%= BASE_URL %>favicon.ico" />
    <title><%= htmlWebpackPlugin.options.title %></title>
  </head>
  <body>
    <noscript>
      <strong
        >We're sorry but <%= htmlWebpackPlugin.options.title %> doesn't work
        properly without JavaScript enabled. Please enable it to
        continue.</strong
      >
    </noscript>
    <div id="main-app"></div>
    <!-- built files will be auto injected -->
  </body>
</html>

```



## 子应用配置

### 创建子应用

```
vue create sub-demo1
```

### 添加element-ui

```
yarn add element-ui
```

### 配置main.js

```
```

### 配置vue.config.js

```
```

